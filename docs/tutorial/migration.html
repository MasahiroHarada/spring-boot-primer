<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DB マイグレーション | Spring Boot 入門</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/spring-boot-primer/assets/css/0.styles.9f3a32a1.css" as="style"><link rel="preload" href="/spring-boot-primer/assets/js/app.dc92be2a.js" as="script"><link rel="preload" href="/spring-boot-primer/assets/js/24.ea749d2d.js" as="script"><link rel="prefetch" href="/spring-boot-primer/assets/js/4.a86bd645.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/2.e3abbe1b.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/3.6e084602.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/5.c7131078.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/6.1584f20b.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/7.3a5c5656.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/8.76902ef0.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/9.06eb8fa2.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/10.e09f378e.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/11.e9b1c808.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/12.f63a1b96.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/13.9f07f086.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/14.0c1ac32a.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/15.c77ef358.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/16.3d40a751.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/17.db41ec13.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/18.429ef17e.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/19.9eef03f2.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/20.9f6de086.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/21.d99a1883.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/22.6c4fa71d.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/23.dcb8ebe9.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/25.858b3b8e.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/26.16eb78a8.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/27.8f2f2af1.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/28.1ef1931d.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/29.54c1e6b5.js"><link rel="prefetch" href="/spring-boot-primer/assets/js/30.91b69efb.js">
    <link rel="stylesheet" href="/spring-boot-primer/assets/css/0.styles.9f3a32a1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/spring-boot-primer/" class="home-link router-link-active"><!----><span class="site-name">
      Spring Boot 入門
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/spring-boot-primer/settings/" class="nav-link">開発環境構築</a></div><div class="nav-item"><a href="/spring-boot-primer/hello-world/" class="nav-link">Hello world!</a></div><div class="nav-item"><a href="/spring-boot-primer/tutorial/" class="nav-link router-link-active">チュートリアル</a></div><div class="nav-item"><a href="/spring-boot-primer/practice/" class="nav-link">演習問題</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/spring-boot-primer/settings/" class="nav-link">開発環境構築</a></div><div class="nav-item"><a href="/spring-boot-primer/hello-world/" class="nav-link">Hello world!</a></div><div class="nav-item"><a href="/spring-boot-primer/tutorial/" class="nav-link router-link-active">チュートリアル</a></div><div class="nav-item"><a href="/spring-boot-primer/practice/" class="nav-link">演習問題</a></div><!----></nav><ul class="sidebar-links"><li><a href="/spring-boot-primer/tutorial/" class="sidebar-link">チュートリアル</a></li><li><a href="/spring-boot-primer/tutorial/sample-application.html" class="sidebar-link">サンプルアプリについて</a></li><li><a href="/spring-boot-primer/tutorial/database-design.html" class="sidebar-link">テーブル定義</a></li><li><a href="/spring-boot-primer/tutorial/url-design.html" class="sidebar-link">URL設計</a></li><li><a href="/spring-boot-primer/tutorial/migration.html" class="active sidebar-link">DB マイグレーション</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring-boot-primer/tutorial/migration.html#db-マイグレーションとは" class="sidebar-link">DB マイグレーションとは</a></li><li class="sidebar-sub-header"><a href="/spring-boot-primer/tutorial/migration.html#flyway" class="sidebar-link">Flyway</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring-boot-primer/tutorial/migration.html#設定" class="sidebar-link">設定</a></li><li class="sidebar-sub-header"><a href="/spring-boot-primer/tutorial/migration.html#マイグレーション実行" class="sidebar-link">マイグレーション実行</a></li><li class="sidebar-sub-header"><a href="/spring-boot-primer/tutorial/migration.html#管理用のテーブルについて" class="sidebar-link">管理用のテーブルについて</a></li></ul></li></ul></li><li><a href="/spring-boot-primer/tutorial/orm.html" class="sidebar-link">Object-Relational マッピング</a></li><li><a href="/spring-boot-primer/tutorial/modify-controller.html" class="sidebar-link">コントローラーを作成する</a></li><li><a href="/spring-boot-primer/tutorial/thymeleaf.html" class="sidebar-link">テンプレートを追加する</a></li><li><a href="/spring-boot-primer/tutorial/all-members.html" class="sidebar-link">メンバー一覧を表示する</a></li><li><a href="/spring-boot-primer/tutorial/search-functionality.html" class="sidebar-link">検索機能を実装しよう</a></li><li><a href="/spring-boot-primer/tutorial/add-member-functionality.html" class="sidebar-link">メンバー追加機能を実装しよう</a></li></ul></div><div class="page"><div class="content"><h1 id="db-マイグレーション"><a href="#db-マイグレーション" aria-hidden="true" class="header-anchor">#</a> DB マイグレーション</h1><h2 id="db-マイグレーションとは"><a href="#db-マイグレーションとは" aria-hidden="true" class="header-anchor">#</a> DB マイグレーションとは</h2><p>DB マイグレーションとは、テーブル定義を管理する仕組みのことです。</p><p>アプリケーションを開発するにあたって、テーブル定義はしばしば変更されるものです。実装着手前の設計段階で変更のない完璧なテーブル定義を作成することは不可能です。初期フェーズの開発中においてさえ設計の変更（テーブルやカラムの追加）は発生しますし、リリースした後もアプリケーションの成長（＝機能追加、仕様変更）に合わせてテーブル定義も当然変化します。</p><p>そこで、変遷するテーブル定義を管理する必要が出てきます。DB マイグレーションツールはたいてい、<strong>どのような SQL をどの順番で実行したか</strong>を管理します。そして実行される SQL 文[^1]はアプリケーションのプロジェクトディレクトリに含まれます。つまりアプリケーションコードと同様に<strong>バージョン管理下に置かれ共有される</strong>ということです。</p><p>ある環境にアプリケーションをリリースするときやチームに新しいメンバーを迎えるとき、このようにテーブル定義の管理がされていると、データベースをあるべき状態に再現することが容易になります。</p><p>[^1]: マイグレーションツールによっては SQL 文ではなく、独自のクラスや設定ファイルでテーブルの状態や変更を表現する場合もあります。</p><h2 id="flyway"><a href="#flyway" aria-hidden="true" class="header-anchor">#</a> Flyway</h2><p>DB マイグレーションを実現するためのライブラリはいくつかあるようですが、今回はその中で <strong>Flyway</strong> というライブラリを使用します。</p><h3 id="設定"><a href="#設定" aria-hidden="true" class="header-anchor">#</a> 設定</h3><h4 id="application-properties"><a href="#application-properties" aria-hidden="true" class="header-anchor">#</a> application.properties</h4><p>最後の行の <code>spring.flyway.enabled</code> に <code>true</code> を指定します。</p><div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:postgresql://localhost:5432/spring-demo</span>
<span class="token attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token attr-value">postgres</span>
<span class="token attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token attr-value">postgres</span>
<span class="token attr-name">spring.datasource.driverClassName</span><span class="token punctuation">=</span><span class="token attr-value">org.postgresql.Driver</span>

<span class="token attr-name">spring.flyway.enabled</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
</code></pre></div><h4 id="sql"><a href="#sql" aria-hidden="true" class="header-anchor">#</a> SQL</h4><p><code>src/main/resources</code> の下に <code>db/migration</code> というディレクトリを作成してください。そしてそのなかに <code>V1__Create_members.sql</code> というファイルを作成してください。Flyway の仕様としてこのファイル名が重要な意味を持つので注意しましょう。</p><div class="language- extra-class"><pre class="language-text"><code>V{バージョン番号}__{任意の名前}.sql
</code></pre></div><p><code>V</code> は大文字で、バージョン番号の右のアンダースコアは2つ必要です。</p><p>SQL ファイルが作成できたら、テーブル定義のページで考えた通りの DDL を記述しましょう。</p><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> members <span class="token punctuation">(</span>
    id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="マイグレーション実行"><a href="#マイグレーション実行" aria-hidden="true" class="header-anchor">#</a> マイグレーション実行</h3><p>たいていの DB マイグレーションツールは管理下にある SQL を適切な順番で実行するためのコマンドを持っています。Flyway もコマンドラインからマイグレーションを実行することが可能ですが、今回のように Spring と連携させて使うとさらに便利で、青瓜ケーションの起動と同時にマイグレーションを実行してくれます。</p><p>というわけで、アプリケーションを起動しましょう。前章の Hello world からアプリケーションを実行中だった場合は一度停止（画面上の赤い四角をクリックしましょう）し、再度起動してください。</p><p>特にエラーがなければマイグレーションは正常に完了しています。</p><p>データベースクライアントツールを起動して <code>spring-demo</code> データベースの内容を確認してみましょう。テーブルが作成されているはずです！</p><h3 id="管理用のテーブルについて"><a href="#管理用のテーブルについて" aria-hidden="true" class="header-anchor">#</a> 管理用のテーブルについて</h3><p>さて、今回は <code>members</code> テーブルだけを作成したはずですが、もう一つテーブルが作成されていませんか？<code>flyway_schema_history</code> です。実は Flyway が「どのような SQL をどの順番で実行したか」を管理するためテーブルなのです。</p><p><code>flyway_schema_history</code> の中を見てみましょう。</p><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> flyway_schema_history<span class="token punctuation">;</span>
</code></pre></div><table><thead><tr><th style="text-align:center">カラム</th><th style="text-align:center">値</th></tr></thead><tbody><tr><td style="text-align:center">installed_rank</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">version</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">description</td><td style="text-align:center">Create members</td></tr><tr><td style="text-align:center">type</td><td style="text-align:center">SQL</td></tr><tr><td style="text-align:center">script</td><td style="text-align:center">V1__Create_members.sql</td></tr><tr><td style="text-align:center">checksum</td><td style="text-align:center">92065422</td></tr><tr><td style="text-align:center">installed_by</td><td style="text-align:center">postgres</td></tr><tr><td style="text-align:center">installed_on</td><td style="text-align:center">2018-07-15 18:02:17.283061</td></tr><tr><td style="text-align:center">execution_time</td><td style="text-align:center">8</td></tr><tr><td style="text-align:center">success</td><td style="text-align:center">true</td></tr></tbody></table><p>すべてカラムの解説はしませんが、<code>installed_rank</code> や <code>script</code>、<code>installed_on</code> といったカラムから「いつどのような SQL をどの順番で実行したか」を管理している様子がうかがえるのではないでしょうか。</p><p>このページでは DB マイグレーションについて紹介しました。</p><p>言語やフレームワークに応じて様々なライブラリがありますが基本的な仕組みはどれも同じなので頭に入れておきましょう。</p></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/spring-boot-primer/tutorial/url-design.html" class="prev">
          URL設計
        </a></span><span class="next"><a href="/spring-boot-primer/tutorial/orm.html">
          Object-Relational マッピング
        </a> →
      </span></p></div></div></div></div>
    <script src="/spring-boot-primer/assets/js/24.ea749d2d.js" defer></script><script src="/spring-boot-primer/assets/js/app.dc92be2a.js" defer></script>
  </body>
</html>
