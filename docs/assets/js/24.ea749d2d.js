(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{175:function(t,a,s){"use strict";s.r(a);var e=s(0),r=Object(e.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("div",{staticClass:"content"},[s("h1",{attrs:{id:"db-マイグレーション"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#db-マイグレーション","aria-hidden":"true"}},[t._v("#")]),t._v(" DB マイグレーション")]),s("h2",{attrs:{id:"db-マイグレーションとは"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#db-マイグレーションとは","aria-hidden":"true"}},[t._v("#")]),t._v(" DB マイグレーションとは")]),s("p",[t._v("DB マイグレーションとは、テーブル定義を管理する仕組みのことです。")]),s("p",[t._v("アプリケーションを開発するにあたって、テーブル定義はしばしば変更されるものです。実装着手前の設計段階で変更のない完璧なテーブル定義を作成することは不可能です。初期フェーズの開発中においてさえ設計の変更（テーブルやカラムの追加）は発生しますし、リリースした後もアプリケーションの成長（＝機能追加、仕様変更）に合わせてテーブル定義も当然変化します。")]),s("p",[t._v("そこで、変遷するテーブル定義を管理する必要が出てきます。DB マイグレーションツールはたいてい、"),s("strong",[t._v("どのような SQL をどの順番で実行したか")]),t._v("を管理します。そして実行される SQL 文[^1]はアプリケーションのプロジェクトディレクトリに含まれます。つまりアプリケーションコードと同様に"),s("strong",[t._v("バージョン管理下に置かれ共有される")]),t._v("ということです。")]),s("p",[t._v("ある環境にアプリケーションをリリースするときやチームに新しいメンバーを迎えるとき、このようにテーブル定義の管理がされていると、データベースをあるべき状態に再現することが容易になります。")]),s("p",[t._v("[^1]: マイグレーションツールによっては SQL 文ではなく、独自のクラスや設定ファイルでテーブルの状態や変更を表現する場合もあります。")]),s("h2",{attrs:{id:"flyway"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#flyway","aria-hidden":"true"}},[t._v("#")]),t._v(" Flyway")]),s("p",[t._v("DB マイグレーションを実現するためのライブラリはいくつかあるようですが、今回はその中で "),s("strong",[t._v("Flyway")]),t._v(" というライブラリを使用します。")]),s("h3",{attrs:{id:"設定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#設定","aria-hidden":"true"}},[t._v("#")]),t._v(" 設定")]),s("h4",{attrs:{id:"application-properties"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#application-properties","aria-hidden":"true"}},[t._v("#")]),t._v(" application.properties")]),s("p",[t._v("最後の行の "),s("code",[t._v("spring.flyway.enabled")]),t._v(" に "),s("code",[t._v("true")]),t._v(" を指定します。")]),s("div",{staticClass:"language-properties extra-class"},[s("pre",{pre:!0,attrs:{class:"language-properties"}},[s("code",[s("span",{attrs:{class:"token attr-name"}},[t._v("spring.datasource.url")]),s("span",{attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{attrs:{class:"token attr-value"}},[t._v("jdbc:postgresql://localhost:5432/spring-demo")]),t._v("\n"),s("span",{attrs:{class:"token attr-name"}},[t._v("spring.datasource.username")]),s("span",{attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{attrs:{class:"token attr-value"}},[t._v("postgres")]),t._v("\n"),s("span",{attrs:{class:"token attr-name"}},[t._v("spring.datasource.password")]),s("span",{attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{attrs:{class:"token attr-value"}},[t._v("postgres")]),t._v("\n"),s("span",{attrs:{class:"token attr-name"}},[t._v("spring.datasource.driverClassName")]),s("span",{attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{attrs:{class:"token attr-value"}},[t._v("org.postgresql.Driver")]),t._v("\n\n"),s("span",{attrs:{class:"token attr-name"}},[t._v("spring.flyway.enabled")]),s("span",{attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{attrs:{class:"token attr-value"}},[t._v("true")]),t._v("\n")])])]),s("h4",{attrs:{id:"sql"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sql","aria-hidden":"true"}},[t._v("#")]),t._v(" SQL")]),s("p",[s("code",[t._v("src/main/resources")]),t._v(" の下に "),s("code",[t._v("db/migration")]),t._v(" というディレクトリを作成してください。そしてそのなかに "),s("code",[t._v("V1__Create_members.sql")]),t._v(" というファイルを作成してください。Flyway の仕様としてこのファイル名が重要な意味を持つので注意しましょう。")]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("V{バージョン番号}__{任意の名前}.sql\n")])])]),s("p",[s("code",[t._v("V")]),t._v(" は大文字で、バージョン番号の右のアンダースコアは2つ必要です。")]),s("p",[t._v("SQL ファイルが作成できたら、テーブル定義のページで考えた通りの DDL を記述しましょう。")]),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" members "),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    id "),s("span",{attrs:{class:"token keyword"}},[t._v("SERIAL")]),t._v(" "),s("span",{attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),s("span",{attrs:{class:"token keyword"}},[t._v("KEY")]),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    name "),s("span",{attrs:{class:"token keyword"}},[t._v("VARCHAR")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{attrs:{class:"token number"}},[t._v("100")]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),s("span",{attrs:{class:"token boolean"}},[t._v("NULL")]),t._v("\n"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"マイグレーション実行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#マイグレーション実行","aria-hidden":"true"}},[t._v("#")]),t._v(" マイグレーション実行")]),s("p",[t._v("たいていの DB マイグレーションツールは管理下にある SQL を適切な順番で実行するためのコマンドを持っています。Flyway もコマンドラインからマイグレーションを実行することが可能ですが、今回のように Spring と連携させて使うとさらに便利で、青瓜ケーションの起動と同時にマイグレーションを実行してくれます。")]),s("p",[t._v("というわけで、アプリケーションを起動しましょう。前章の Hello world からアプリケーションを実行中だった場合は一度停止（画面上の赤い四角をクリックしましょう）し、再度起動してください。")]),s("p",[t._v("特にエラーがなければマイグレーションは正常に完了しています。")]),s("p",[t._v("データベースクライアントツールを起動して "),s("code",[t._v("spring-demo")]),t._v(" データベースの内容を確認してみましょう。テーブルが作成されているはずです！")]),s("h3",{attrs:{id:"管理用のテーブルについて"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#管理用のテーブルについて","aria-hidden":"true"}},[t._v("#")]),t._v(" 管理用のテーブルについて")]),s("p",[t._v("さて、今回は "),s("code",[t._v("members")]),t._v(" テーブルだけを作成したはずですが、もう一つテーブルが作成されていませんか？"),s("code",[t._v("flyway_schema_history")]),t._v(" です。実は Flyway が「どのような SQL をどの順番で実行したか」を管理するためテーブルなのです。")]),s("p",[s("code",[t._v("flyway_schema_history")]),t._v(" の中を見てみましょう。")]),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),s("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" flyway_schema_history"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("カラム")]),s("th",{staticStyle:{"text-align":"center"}},[t._v("値")])])]),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("installed_rank")]),s("td",{staticStyle:{"text-align":"center"}},[t._v("1")])]),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("version")]),s("td",{staticStyle:{"text-align":"center"}},[t._v("1")])]),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("description")]),s("td",{staticStyle:{"text-align":"center"}},[t._v("Create members")])]),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("type")]),s("td",{staticStyle:{"text-align":"center"}},[t._v("SQL")])]),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("script")]),s("td",{staticStyle:{"text-align":"center"}},[t._v("V1__Create_members.sql")])]),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("checksum")]),s("td",{staticStyle:{"text-align":"center"}},[t._v("92065422")])]),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("installed_by")]),s("td",{staticStyle:{"text-align":"center"}},[t._v("postgres")])]),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("installed_on")]),s("td",{staticStyle:{"text-align":"center"}},[t._v("2018-07-15 18:02:17.283061")])]),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("execution_time")]),s("td",{staticStyle:{"text-align":"center"}},[t._v("8")])]),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("success")]),s("td",{staticStyle:{"text-align":"center"}},[t._v("true")])])])]),s("p",[t._v("すべてカラムの解説はしませんが、"),s("code",[t._v("installed_rank")]),t._v(" や "),s("code",[t._v("script")]),t._v("、"),s("code",[t._v("installed_on")]),t._v(" といったカラムから「いつどのような SQL をどの順番で実行したか」を管理している様子がうかがえるのではないでしょうか。")]),s("p",[t._v("このページでは DB マイグレーションについて紹介しました。")]),s("p",[t._v("言語やフレームワークに応じて様々なライブラリがありますが基本的な仕組みはどれも同じなので頭に入れておきましょう。")])])}],!1,null,null,null);a.default=r.exports}}]);